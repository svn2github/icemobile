<!DOCTYPE html>
<!--
  ~ Copyright 2004-2013 ICEsoft Technologies Canada Corp.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the
  ~ License. You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an "AS
  ~ IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
  ~ express or implied. See the License for the specific language
  ~ governing permissions and limitations under the License.
  -->

<html>
<head>
	<title>ICEmobile GeoSpy</title>
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<script type="text/javascript" src="./jquery/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="../icemobile-resources/javascript/icemobile.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script type="text/javascript" src="/icemobilespring/code.icepush"></script>
<script type="text/javascript">
    var urlBase = (''+window.location).match(/.*\//) + '../';
    ice.push.configuration.contextPath = urlBase;
    ice.push.configuration.blockingConnectionURI =
            urlBase + "listen.icepush";
    ice.push.configuration.createPushIdURI =
            urlBase + "create-push-id.icepush";
    ice.push.configuration.notifyURI =
            urlBase + "notify.icepush";
    ice.push.configuration.addGroupMemberURI =
            urlBase + "add-group-member.icepush";
    ice.push.configuration.removeGroupMemberURI =
            urlBase + "remove-group-member.icepush";

    var pagePushId = ice.push.createPushId();
    ice.push.addGroupMember("geospy", pagePushId);
    ice.push.register([pagePushId], function(pushIds) {
        console.log("notified");
        updateMarkers();
    });
</script>
    <style>
      html, body, #map-canvas {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    .ui-header .ui-title {
        margin-right: 10%;
        margin-left: 10%;
    }
    .mobi-container .mobi-stock {
        display: none;
    }
    .mobi-stock .mobi-container {
        display: none;
    }
    .imageout img {
        height: 80px;
        width: 80px;
        padding: 10px;
    }
    button {
        height: 50px;
        line-height : 50px;
        background-color: white;
        font-weight: bold;
        margin: 10px;
    }
    .thumb img {
        float:right;
    }
    </style>

    <script>
        var map;
        function initialize() {
            var mapOptions = {
                maxZoom: 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document
                    .getElementById('map-canvas'), mapOptions);

            var overlay = document.getElementById('overlay');
            map.controls[google.maps.ControlPosition.RIGHT_TOP]
                    .push(overlay);
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>

</head>
<body>
    <script>

    function handleSpy(event)  {
    }

    function processMarkers(data)  {
        var markerData = data.markers;
        var len = markerData.length;
        var markers = new Array();
        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < len; i++) {
            var location = new google.maps.LatLng(
                    markerData[i][0], markerData[i][1]);
            bounds.extend(location);
            new google.maps.Marker({
                position: location,
                map: map
            });
        }
        map.fitBounds(bounds);
    }

    function updateMarkers()  {
        $.ajax({
            url: (''+window.location).match(/.*\//) + '../geospymarkers',
            cache: false
        }).done(function( data ) {
            processMarkers(data);
        });
    }
    
    ice.ajaxRefresh = function()  {
        updateMarkers();
    }

    updateMarkers();
    </script>

    <div id="map-canvas"></div>

    <div id="overlay" >
        <button id="go" onclick="ice.mobi.geoSpy('_geo',handleSpy, {postURL:(''+window.location).match(/.*\//) + '../geospy/'});">Track Location ... </button>
    </div>
	        
</body>
</html>

