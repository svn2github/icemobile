<!--
  ~ Copyright 2004-2012 ICEsoft Technologies Canada Corp.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the
  ~ License. You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an "AS
  ~ IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
  ~ express or implied. See the License for the specific language
  ~ governing permissions and limitations under the License.
  -->

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
             xmlns:h="http://java.sun.com/jsf/html"
             xmlns:f="http://java.sun.com/jsf/core"
             xmlns:ui="http://java.sun.com/jsf/facelets"
             xmlns:icecore="http://www.icefaces.org/icefaces/core"
             xmlns:mobi="http://www.icesoft.com/icefaces/mobile/component"
             id="geoLocFrag">

    <h:form prependId="false">

        <mobi:geolocation latitude="#{geoLocationBean.latitude}"
                          longitude="#{geoLocationBean.longitude}"
                          altitude="#{geoLocationBean.altitude}"
                          direction="#{geoLocationBean.direction}"/>


        <h:panelGroup style="display:block;padding-left:10px;">
            <canvas id="mapCanvas" width="300" height="150"/>
            <br/>
            <mobi:commandButton buttonType="default" value="Locate Me"/>
        </h:panelGroup>

        <mobi:fieldsetGroup>
            <mobi:fieldsetRow>
                Latitude: <h:outputText value="#{geoLocationBean.latitude}"/>
            </mobi:fieldsetRow>
            <mobi:fieldsetRow>
                Longitude: <h:outputText value="#{geoLocationBean.longitude}"/>
            </mobi:fieldsetRow>
            <mobi:fieldsetRow rendered="#{geoLocationBean.direction gt 0.0}">
                Direction: <h:outputText value="#{geoLocationBean.direction}"/>
            </mobi:fieldsetRow>
            <mobi:fieldsetRow rendered="#{geoLocationBean.altitude gt 0.0}">
                Altitude: <h:outputText value="#{geoLocationBean.altitude}"/>
            </mobi:fieldsetRow>
        </mobi:fieldsetGroup>


    </h:form>
    <script type="text/javascript">

        function showLocation() {
            var canvas = document.getElementById('mapCanvas');
            if (!canvas) {
                return;
            }
            // temporary work around for drawing location on canvas
            var lat = '#{geoLocationBean.latitude}';
            var lon = '#{geoLocationBean.longitude}';

            if (canvas.getContext) {
                var ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, 600, 400);
                var height = canvas.height;
                var width = canvas.width;

                ctx.drawImage(image, 0, 0, width, height);
                var x = Math.floor(lon * width / 2 / 180 + (width / 2));
                var y = Math.floor(-1 * lat * (height / 2) / 90 + (height / 2));
                ctx.fillStyle = "#FFFF00";
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2, true);
                ctx.fill();
            }
        }

        function updateLocation(data) {
            if (data.status == "success") {
                showLocation();
            }
        }

        var image = new Image();
        //scaled and cropped http://nf.nci.org.au/facilities/software/GMT/4.3.1/doc/html/GMT_Docs/node97.html
        image.src = "#{resource['images:map.png']}";
        image.onload = function() {
            showLocation();
        }

        jsf.ajax.addOnEvent(updateLocation);

    </script>


</ui:composition>